<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Mi√∞annarverkefni</title>
        <script src="./js/phaser.js"></script>
    </head>

    <body>
        <script>
            
            var config = {
                type: Phaser.AUTO,
                width: 1024,
                height: 600,
                physics: {
                    default: 'arcade',
                    arcade: {
                        gravity: { y: 300 },
                        debug: false
                    }
                },
                scene: {
                    preload: preload,
                    create: create,
                    update: update
                }
            };
            
            var score = 0;
            var scoreText;
            var lastx = 0;
            var lasty = 0;

            var game = new Phaser.Game(config);
        
            function preload ()
            {
                this.load.image('background', 'assets/background.jpg');
                this.load.image('ground', 'assets/platform.png');
                this.load.image('star', 'assets/star.png');
                this.load.image('bomb', 'assets/bomb.png');
                this.load.spritesheet('box_dude', 
                    'assets/box_dude.png',
                    { frameWidth: 32, frameHeight: 32 }
                );
                this.load.image('gplain', 'assets/ground_plain.png');
                this.load.image('mparticle', 'assets/move_particle.png');
                this.load.image('smoke', 'assets/smoke-puff.png');
                this.load.image('gun1', 'assets/gun1.png');
            }
        
            function create ()
            {   
                /* Adds the background to the scene */
                this.add.image(1440, 900, 'background');



                /* <PARTICLES> */
                mparticles = this.add.particles('mparticle');
                window.emitter = mparticles.createEmitter({
                    speed: 50,
                    scale: { start: 1, end: 0 },
                    blendMode: 'ADD'
                });
                smokeparticle = this.add.particles('smoke');
                window.smokeEmitter = smokeparticle.createEmitter({
                    speed: 0,
                    scale: { start: 0.55, end: 0 }
                });
                /* </PARTICLES> */


                /* <PLATFORM CREATIONS AND PLACEMETNS> */
                groundplain = this.physics.add.staticGroup();
                groundplain.create(1440, 1768, 'gplain').setScale(2).refreshBody();

                platforms = this.physics.add.staticGroup();
                platforms.create(400, 568, 'ground').setScale(2).refreshBody();

                platforms.create(600, 400, 'ground');
                platforms.create(50, 250, 'ground');
                platforms.create(750, 220, 'ground');
                platforms.create(360, 1570, 'gplain').setScale(0.5).refreshBody();
                platforms.create(281, 1400, 'gplain').setScale(0.4).refreshBody();
                platforms.create(281, 1220, 'gplain').setScale(0.1).refreshBody();
                platforms.create(560, 1100, 'gplain').setScale(0.4).refreshBody();
                platforms.create(900, 950, 'gplain').setScale(0.5).refreshBody();
                platforms.create(620, 770, 'gplain').setScale(0.5).refreshBody();
                platforms.create(800, 650, 'gplain').setScale(0.1).refreshBody();
                /* </PLATFORM CREATIONS AND PLACEMETNS> */

                /* adds the player spirte to the scene */    
                player = this.physics.add.sprite(100, 1650, 'box_dude');
                /* basic settings for the player */
                player.setBounce(0.2);
                player.setCollideWorldBounds(true);


                /* <ANIMATIONS> */
                this.anims.create({
                    key: 'left', /* key used to access animation and use */
                    frames: [ {key: "box_dude", frame: 0} ], /* selects what frame of the spiritesheet it should use*/
                    frameRate: 10,
                    repeat: -1 /* Loops */
                });

                this.anims.create({
                    key: 'turn',
                    frames: [ { key: 'box_dude', frame: 1 } ],
                    frameRate: 20
                });

                this.anims.create({
                    key: 'right',
                    frames: [ { key: 'box_dude', frame: 2 } ],
                    frameRate: 10,
                    repeat: -1
                });
                /* </ANIMATIONS> */

                cursors = this.input.keyboard.createCursorKeys();

                stars = this.physics.add.group({
                    key: 'star',
                    repeat: 11,
                    setXY: { x: 12, y: 0, stepX: 70 }
                });

                stars.children.iterate(function (child) {
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
                });
                
                scoreText = this.add.text(16, 16, 'Score: 0', { fontSize: '32px', fill: '#000' });
                scoreText.fixedToCamera = true;

                bombs = this.physics.add.group();

                this.physics.world.setBounds(0,0,2880,1800);  /* rezises the worldbounds from 0x0-800x600 to 0x0-2880x1880 (same as background size)*/

                /* some colliders */
                this.physics.add.collider(player, platforms);
                this.physics.add.collider(stars, platforms);
                this.physics.add.overlap(player, stars, collectStar, null, this);
                this.physics.add.collider(bombs, platforms);
                this.physics.add.collider(player, bombs, hitBomb, null, this);
                this.physics.add.collider(player, groundplain);

                /* main camera settings */
                this.cameras.main.setSize(1024, 600);
                this.cameras.main.startFollow(player);
                this.cameras.main.setBounds(0, 0, 2880, 1800); /* sets the camerabounds to the same as the worldbounds */

                /* TODO: fix minimap */
                /*this.minimap = this.cameras.add(300, 200, 360, 235).setZoom(0.1);*/
                

                /* Object that holds all data for every gun pickup */
                this.guns = [gun1 = {
                    'texture' : 'gun1',
                    'bullet_texture' : 'gun1_bullet',
                    'firespeed' : 1,
                    'bulletspeed' : 10,
                    'damage' : 5
                },
                gun2 = {
                    'texture' : 'gun2',
                    'bullet_texture' : 'gun2_bullet',
                    'firespeed' : 5,
                    'bulletspeed' : 15,
                    'damage' : 5
                }]

                var gunHeld;

                

            }

            function update(){
                if (cursors.left.isDown)
                {
                    player.setVelocityX(-160);

                    player.anims.play('left', true);
                }
                else if (cursors.right.isDown)
                {
                    player.setVelocityX(160);

                    player.anims.play('right', true);
                }
                else
                {
                    player.setVelocityX(0);

                    player.anims.play('turn');
                }

                if (cursors.up.isDown && (player.body.touching.down || player.y == 1784))
                {
                    player.setVelocityY(-330);
                    smokeEmitter.setPosition(player.x + 0, player.y + 15);
                }
                else{
                    smokeEmitter.setPosition(-10, -10);
                }
                if (cursors.down.isDown)
                {
                    if(!player.body.touching.down)
                    {
                        player.setVelocityY(440);
                    }
                }
                if(player.x != lastx || player.y != lasty){
                    /* console.log(player.x + "  " + player.y) */
                    lastx = player.x;
                    lasty = player.y;
                    
                    moving = true;
                }else{
                    moving = false;
                }
                if(moving && player.body.touching.down){
                    emitter.setPosition(player.x + 0, player.y + 15);
                }else{
                    emitter.setPosition(-10, -10);
                }
                if(moving && !player.body.touching.down)
                {
                    inAir = true;
                }else{
                    inAir = false;
                }
                      
            }

            function collectStar(player, star)
            {
                star.disableBody(true, true);

                score += 10;
                scoreText.setText('Score: ' + score);
                if (stars.countActive(true) === 0)
                {
                    stars.children.iterate(function (child) {

                        child.enableBody(true, child.x, 0, true, true);

                    });

                    var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

                    var bomb = bombs.create(x, 16, 'bomb');
                    bomb.setBounce(1);
                    bomb.setCollideWorldBounds(true);
                    bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                    bomb.allowGravity = false;

                }
            }

            function hitBomb (player, bomb)
            {
                this.physics.pause();

                player.setTint(0xff0000);

                player.anims.play('turn');

                gameOver = true;
            }
            </script>
    </body>
</html>